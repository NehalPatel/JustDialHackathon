{% extends "base.html" %}

{% block title %}Results - Video Auto-Moderation System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 mb-3">
            <i class="fas fa-chart-line me-3"></i>
            Moderation Results
        </h1>
        <p class="lead text-muted">View and analyze your video moderation history and results.</p>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3 mb-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="dateFilter" class="form-label">Date Range</label>
                <select class="form-select" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="searchInput" class="form-label">Search</label>
                <input type="text" class="form-control" id="searchInput" 
                       placeholder="Search by filename or ID...">
            </div>
            <div class="col-md-2 mb-3">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                    <i class="fas fa-filter me-2"></i>Filter
                </button>
            </div>
        </div>
        
        <!-- Custom Date Range (hidden by default) -->
        <div class="row mt-3" id="customDateRange" style="display: none;">
            <div class="col-md-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate">
            </div>
        </div>
    </div>
</div>

<!-- Results Summary -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Videos</h6>
                        <h3 class="mb-0" id="totalCount">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-video fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Approved</h6>
                        <h3 class="mb-0" id="approvedCount">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Rejected</h6>
                        <h3 class="mb-0" id="rejectedCount">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Avg. Confidence</h6>
                        <h3 class="mb-0" id="avgConfidence">-</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-percentage fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Moderation History
        </h5>
        <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshResults()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="exportResults()">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="resultsTable">
                <thead class="table-light">
                    <tr>
                        <th>Video</th>
                        <th>Status</th>
                        <th>Confidence</th>
                        <th>Issues Detected</th>
                        <th>Processing Time</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    <!-- Results will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading State -->
        <div class="text-center py-5" id="loadingState">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading results...</p>
        </div>
        
        <!-- Empty State -->
        <div class="text-center py-5" id="emptyState" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No results found</h5>
            <p class="text-muted">Try adjusting your filters or upload some videos to get started.</p>
            <a href="/upload" class="btn btn-primary">
                <i class="fas fa-upload me-2"></i>Upload Video
            </a>
        </div>
    </div>
    
    <!-- Pagination -->
    <div class="card-footer">
        <nav aria-label="Results pagination">
            <ul class="pagination justify-content-center mb-0" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Result Detail Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Moderation Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadBtn" onclick="downloadVideo()">
                    <i class="fas fa-download me-2"></i>Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash me-2"></i>
                    Delete Result
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this moderation result?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentFilters = {};
    let selectedResultId = null;
    
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadResults();
        loadSummary();
        
        // Setup date filter change handler
        document.getElementById('dateFilter').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'block';
            } else {
                customRange.style.display = 'none';
            }
        });
    });

    async function loadResults(page = 1) {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const tableBody = document.getElementById('resultsTableBody');
        
        loadingState.style.display = 'block';
        emptyState.style.display = 'none';
        tableBody.innerHTML = '';

        try {
            const params = new URLSearchParams({
                page: page,
                ...currentFilters
            });

            const response = await fetch(`/moderation/api/results?${params}`);
            const data = await response.json();

            loadingState.style.display = 'none';

            if (data.results && data.results.length > 0) {
                renderResults(data.results);
                renderPagination(data.pagination);
            } else {
                emptyState.style.display = 'block';
            }

        } catch (error) {
            console.error('Failed to load results:', error);
            loadingState.style.display = 'none';
            showAlert('Failed to load results. Please try again.', 'danger');
        }
    }

    async function loadSummary() {
        try {
            const response = await fetch('/moderation/api/statistics');
            const stats = await response.json();

            document.getElementById('totalCount').textContent = stats.total_videos || 0;
            document.getElementById('approvedCount').textContent = stats.approved || 0;
            document.getElementById('rejectedCount').textContent = stats.rejected || 0;
            document.getElementById('avgConfidence').textContent = 
                stats.avg_confidence ? `${Math.round(stats.avg_confidence)}%` : '-';

        } catch (error) {
            console.error('Failed to load summary:', error);
        }
    }

    function renderResults(results) {
        const tableBody = document.getElementById('resultsTableBody');
        
        tableBody.innerHTML = results.map(result => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-video text-primary me-2"></i>
                        <div>
                            <div class="fw-bold">${result.filename}</div>
                            <small class="text-muted">${formatFileSize(result.file_size || 0)}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-${result.decision === 'approved' ? 'success' : 'danger'}">
                        <i class="fas fa-${result.decision === 'approved' ? 'check' : 'times'} me-1"></i>
                        ${result.decision.charAt(0).toUpperCase() + result.decision.slice(1)}
                    </span>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-${getConfidenceColor(result.confidence)}" 
                                 style="width: ${result.confidence}%"></div>
                        </div>
                        <span class="small">${Math.round(result.confidence)}%</span>
                    </div>
                </td>
                <td>
                    <div class="d-flex flex-wrap gap-1">
                        ${renderViolations(result.violations)}
                    </div>
                </td>
                <td>
                    <span class="text-muted">${formatDuration(result.processing_time || 0)}</span>
                </td>
                <td>
                    <span class="text-muted">${formatDate(result.created_at)}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewResult('${result.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteResult('${result.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function renderViolations(violations) {
        if (!violations || violations.length === 0) {
            return '<span class="badge bg-success">Clean</span>';
        }

        return violations.map(violation => {
            const colors = {
                'nudity': 'danger',
                'copyright': 'warning',
                'fraud': 'info',
                'violence': 'dark',
                'poor_quality': 'secondary'
            };
            
            // Handle both string and object violations
            const violationType = typeof violation === 'object' ? violation.type : violation;
            const violationText = typeof violation === 'object' ? 
                `${violation.type} (${(violation.score * 100).toFixed(0)}%)` : 
                violation;
            
            return `<span class="badge bg-${colors[violationType] || 'secondary'}">${violationText}</span>`;
        }).join('');
    }

    function renderPagination(pagination) {
        const paginationEl = document.getElementById('pagination');
        
        if (!pagination || pagination.total_pages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }

        let html = '';
        
        // Previous button
        html += `
            <li class="page-item ${pagination.current_page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadResults(${pagination.current_page - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Page numbers
        for (let i = 1; i <= pagination.total_pages; i++) {
            if (i === 1 || i === pagination.total_pages || 
                (i >= pagination.current_page - 2 && i <= pagination.current_page + 2)) {
                html += `
                    <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadResults(${i})">${i}</a>
                    </li>
                `;
            } else if (i === pagination.current_page - 3 || i === pagination.current_page + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        // Next button
        html += `
            <li class="page-item ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadResults(${pagination.current_page + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        paginationEl.innerHTML = html;
    }

    function applyFilters() {
        currentFilters = {
            status: document.getElementById('statusFilter').value,
            date_range: document.getElementById('dateFilter').value,
            search: document.getElementById('searchInput').value
        };

        if (currentFilters.date_range === 'custom') {
            currentFilters.start_date = document.getElementById('startDate').value;
            currentFilters.end_date = document.getElementById('endDate').value;
        }

        currentPage = 1;
        loadResults(1);
        loadSummary();
    }

    async function viewResult(resultId) {
        try {
            const response = await fetch(`/moderation/api/results/${resultId}`);
            const result = await response.json();

            const modalBody = document.getElementById('resultModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Video Information</h6>
                        <table class="table table-sm">
                            <tr><td>Filename:</td><td>${result.filename}</td></tr>
                            <tr><td>File Size:</td><td>${formatFileSize(result.file_size || 0)}</td></tr>
                            <tr><td>Duration:</td><td>${formatDuration(result.duration || 0)}</td></tr>
                            <tr><td>Resolution:</td><td>${result.resolution || 'Unknown'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Moderation Result</h6>
                        <table class="table table-sm">
                            <tr><td>Decision:</td><td>
                                <span class="badge bg-${result.decision === 'approved' ? 'success' : 'danger'}">
                                    ${result.decision.charAt(0).toUpperCase() + result.decision.slice(1)}
                                </span>
                            </td></tr>
                            <tr><td>Confidence:</td><td>${Math.round(result.confidence)}%</td></tr>
                            <tr><td>Processing Time:</td><td>${formatDuration(result.processing_time || 0)}</td></tr>
                            <tr><td>Analyzed:</td><td>${formatDate(result.created_at)}</td></tr>
                        </table>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="fw-bold">Detection Results</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Nudity</h6>
                                <h4 class="text-${result.nudity_score > 50 ? 'danger' : 'success'}">
                                    ${Math.round(result.nudity_score || 0)}%
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Copyright</h6>
                                <h4 class="text-${result.copyright_score > 60 ? 'warning' : 'success'}">
                                    ${Math.round(result.copyright_score || 0)}%
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Fraud</h6>
                                <h4 class="text-${result.fraud_score > 50 ? 'info' : 'success'}">
                                    ${Math.round(result.fraud_score || 0)}%
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Quality</h6>
                                <h4 class="text-${result.quality_score < 50 ? 'secondary' : 'success'}">
                                    ${Math.round(result.quality_score || 0)}%
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="fw-bold">Reasoning</h6>
                <p class="text-muted">${result.reasoning || 'No detailed reasoning available.'}</p>
                
                ${result.violations && result.violations.length > 0 ? `
                    <h6 class="fw-bold">Violations Detected</h6>
                    <div class="d-flex flex-wrap gap-2">
                        ${result.violations.map(v => {
                            const violationType = typeof v === 'object' ? v.type : v;
                            const violationText = typeof v === 'object' ? 
                                `${v.type} (${(v.score * 100).toFixed(0)}%)` : 
                                v;
                            return `<span class="badge bg-danger">${violationText}</span>`;
                        }).join('')}
                    </div>
                ` : ''}
            `;

            selectedResultId = resultId;
            resultModal.show();

        } catch (error) {
            console.error('Failed to load result details:', error);
            showAlert('Failed to load result details.', 'danger');
        }
    }

    function deleteResult(resultId) {
        selectedResultId = resultId;
        deleteModal.show();
        
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            deleteModal.hide();
            
            try {
                const response = await fetch(`/moderation/api/results/${resultId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('Result deleted successfully!', 'success');
                    loadResults(currentPage);
                    loadSummary();
                } else {
                    showAlert('Failed to delete result.', 'danger');
                }

            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Failed to delete result.', 'danger');
            }
        };
    }

    function refreshResults() {
        loadResults(currentPage);
        loadSummary();
        showAlert('Results refreshed!', 'info');
    }

    function exportResults() {
        const params = new URLSearchParams(currentFilters);
        window.open(`/moderation/api/export?${params}`, '_blank');
    }

    function downloadVideo() {
        if (selectedResultId) {
            window.open(`/moderation/api/download/${selectedResultId}`, '_blank');
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Unknown';
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
</script>
{% endblock %}